<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  <!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
</head>
<body>

<div class="container">     
  <table class="table table-dark table-hover">
 <h1>User Management System</h1>
    <button class="btn btn-warning" id="createUser">Generate New User</button>
    <button class="btn btn-warning" id="removeAll">Remove All</button>
    <thead>
      <tr>
        <th>id</th>
        <th>name</th>
        <th>gender</th>
        <th>Email</th>
        <th>address</th>
        <th>action</th>
      </tr>
    </thead>
    <tbody id="users">
    </tbody>
  </table>
  
  <!-- Modal -->
  <div class="modal fade" id="upModal" role="dialog">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body" id="modalUserData">
            
            
        </div>
        <div class="modal-footer" id="footerButton">
          
        </div>
      </div>
    </div>
  </div>
  
</div>
<script type="text/javascript" th:inline="javascript">
	var serverAddress = /*[[${@environment.getProperty('server.address')}]]*/ 'default';
	var serverport = /*[[${@environment.getProperty('server.port')}]]*/ 'default';
	
	var socketIOPort = /*[[${@environment.getProperty('socket.io.port')}]]*/ 'default';
	var socketAddress = /*[[${@environment.getProperty('socket.io.host')}]]*/ 'default';
	var server = socketAddress+":"+socketIOPort;
	var endpoint = "http://"+serverAddress+":"+serverport;
	var socket =  io.connect(server);
  $(document).ready(function(){
	  
      // $('.dlUser').click(function(){
      //   deleteUser(this.id);
      //   $(this).parent('tr').remove();
      // });
      
      // ========================== create user socketio event ==============================
      $('#createUser').click(function() {
    	  $user = {
  			    name  : "Doe",
  			    gender      : "male",
  			    email  : "blue@gmail.com",
  			    address: "PP"
  			};
    	  socket.emit('createUserButton', $user);
      });
      socket.on('createUserEvent', function(data) {
          $body = `
              <tr>
	            <td>`+data.id +`</td>
	            <td>`+data.name +`</td>
	            <td>`+data.gender +`</td>
	            <td>`+data.email +`</td>
	            <td>`+data.address +`</td>
	            <td><button class="btn btn-warning col-md-12 upUser" data-toggle="modal" data-target="#upModal" onClick="openModalUpdate(`+ data.id +`)" id="up`+ data.id +`">update</button></td>
	            <td><button class="btn btn-danger col-md-12 dlUser" onClick="deleteUser(`+ data.id +`)" id="dl`+ data.id +`">delete</button></td>
              </tr>
            `;
          $("#users").append($body);
      });
      // ========================== end create user socketio event ==============================
        
      
      // ========================== remove all users socketio event ==============================
      $("#removeAll").click(function() {
    	 socket.emit('removeAllButton', 'remove...');
      });
      
      socket.on('removeAllEvent', function(data) {
          console.log(data);
    	  $("#users").empty();
      });
      // ========================== end remove all users socketio event ==============================
    	  

      // $(".dlUser").click(function() {
    	  // console.log("heleo");
    	  // socket.emit('removeIdEvent', id);
      // });
      socket.on('removeIdEvent', function(data) {
    	    console.log(data);
    	    var id = data.split(" ")[1];
    	    $td = $(".dlUser#dl"+id).parent("td");
    	    $td.parent('tr').fadeOut(150);
      });
      
      socket.on('updateEvent', function(data) {
          console.log(data);
    });
      
      
  });
  
  get();
  
  function get() {
      $.ajax({
          method : 'GET', 
          url : endpoint+"/users", 
          beforeSend: function(){
              console.log("sending...");
          },
          timeout: 5000,
          success:function(response){
        	console.log("completed")
            for(i = 0; i<response.length; i++) {
              $body = `
                    <tr>
                  <td>`+response[i].id +`</td>
                  <td>`+response[i].name +`</td>
                  <td>`+response[i].gender +`</td>
                  <td>`+response[i].email +`</td>
                  <td>`+response[i].address +`</td>
                  <td><button class="btn btn-warning col-md-12 upUser" data-toggle="modal" data-target="#upModal" onClick="openModalUpdate(`+ response[i].id +`)" id="up`+ response[i].id +`">update</button></td>
                  <td><button class="btn btn-danger col-md-12 dlUser" onClick="deleteUser(`+ response[i].id +`)" id="dl`+ response[i].id +`">delete</button></td>
                    </tr>
                  `;
                $("#users").append($body);
            }
          },
          error : function(error){
          }
      });
  }
  function deleteUser(id) {
      socket.emit('removeIdButton', id);
      console.log(id);
  }
  
  function upUser(id) {
      socket.emit('updateButton', id);
      console.log(id);
  }
  
  function openModalUpdate(id) {
	  $body = 
		  `
		    <input type="text" id="name" class="form-control" placeholder="name">
            <hr>
            <input type="text" id="gender" class="form-control" placeholder="gender">
            <hr>
            <input type="text" id="email" class="form-control" placeholder="email">
            <hr>
            <input type="text" id="address" class="form-control" placeholder="address">
		  `;
	    $("#modalUserData").html($body);
	  $bodyFooter =
		  `
		  <button type="button" class="btn btn-primary" id="upUser" onClick="upUser(${id})">submit</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  `;
	  $("#footerButton").html($bodyFooter);
  }
</script>

</body>
</html>
